<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>çŒ«é—¨æ™ºèƒ½æ’ç‰ˆå™¨</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, 'PingFang SC', sans-serif;
      background: #f8f7f5;
      min-height: 100vh;
      color: #333;
    }
    
    /* é¡¶éƒ¨å¯¼èˆª */
    .header {
      background: #fff;
      border-bottom: 1px solid #eee;
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    
    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #9b8b7d 0%, #c4b5a5 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }
    
    .btn-secondary:hover {
      background: #eee;
    }
    
    .btn-primary {
      background: #333;
      color: #fff;
    }
    
    .btn-primary:hover {
      background: #555;
    }
    
    /* ä¸»å®¹å™¨ */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 24px;
      min-height: calc(100vh - 70px);
    }
    
    @media (max-width: 1000px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    /* å·¦ä¾§ç¼–è¾‘åŒº */
    .editor-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .panel {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .panel-header {
      padding: 16px 20px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-title {
      font-size: 15px;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .panel-title-icon {
      width: 24px;
      height: 24px;
      background: #f5f5f5;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    /* è¾“å…¥åŒº */
    .input-section {
      padding: 20px;
    }
    
    .textarea-wrapper {
      position: relative;
    }
    
    .main-textarea {
      width: 100%;
      min-height: 200px;
      padding: 16px;
      border: 2px dashed #e0e0e0;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.8;
      resize: vertical;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    
    .main-textarea:focus {
      outline: none;
      border-color: #9b8b7d;
      border-style: solid;
    }
    
    .main-textarea::placeholder {
      color: #bbb;
    }
    
    .input-hint {
      margin-top: 12px;
      font-size: 13px;
      color: #999;
      line-height: 1.6;
    }
    
    .input-hint code {
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
    }
    
    /* é…è‰²é€‰æ‹© */
    .scheme-section {
      padding: 16px 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .scheme-label {
      font-size: 14px;
      color: #666;
      white-space: nowrap;
    }
    
    .scheme-options {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .scheme-btn {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .scheme-btn:hover {
      transform: scale(1.1);
    }
    
    .scheme-btn.active {
      border-color: #333;
    }
    
    /* æ“ä½œæŒ‰é’® */
    .action-section {
      padding: 16px 20px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 12px;
    }
    
    .btn-parse {
      flex: 1;
      padding: 14px 24px;
      background: linear-gradient(135deg, #9b8b7d 0%, #b8a898 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .btn-parse:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(155, 139, 125, 0.3);
    }
    
    .btn-add-image {
      padding: 14px 20px;
      background: #f8f8f8;
      color: #666;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-add-image:hover {
      background: #f0f0f0;
    }
    
    /* æ¨¡å—ç¼–è¾‘åŒº */
    .blocks-container {
      padding: 20px;
      min-height: 300px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #bbb;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .empty-state-text {
      font-size: 14px;
      line-height: 1.8;
    }
    
    /* å•ä¸ªæ¨¡å— */
    .block-item {
      background: #fafafa;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
      border: 1px solid transparent;
      transition: all 0.2s;
    }
    
    .block-item:hover {
      border-color: #e0e0e0;
    }
    
    .block-item.editing {
      border-color: #9b8b7d;
      box-shadow: 0 2px 8px rgba(155, 139, 125, 0.15);
    }
    
    .block-header {
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f5f5f5;
      cursor: move;
    }
    
    .block-type {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .block-type-badge {
      padding: 4px 10px;
      background: #fff;
      border-radius: 6px;
      font-size: 12px;
      color: #666;
      font-weight: 500;
    }
    
    .block-type-select {
      padding: 4px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 12px;
      background: #fff;
      cursor: pointer;
      font-family: inherit;
    }
    
    .block-actions {
      display: flex;
      gap: 4px;
    }
    
    .block-action-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #999;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .block-action-btn:hover {
      background: #e8e8e8;
      color: #666;
    }
    
    .block-action-btn.delete:hover {
      background: #ffe5e5;
      color: #e74c3c;
    }
    
    .block-content {
      padding: 16px;
    }
    
    .block-textarea {
      width: 100%;
      min-height: 60px;
      padding: 12px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.8;
      resize: vertical;
      font-family: inherit;
      background: #fff;
    }
    
    .block-textarea:focus {
      outline: none;
      border-color: #9b8b7d;
    }
    
    /* å›¾ç‰‡æ¨¡å— */
    .block-image-wrapper {
      text-align: center;
    }
    
    .block-image {
      max-width: 100%;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .image-url-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
      font-size: 13px;
      font-family: inherit;
    }
    
    .image-url-input:focus {
      outline: none;
      border-color: #9b8b7d;
    }
    
    .image-upload-area {
      padding: 30px;
      border: 2px dashed #ddd;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .image-upload-area:hover {
      border-color: #9b8b7d;
      background: #faf9f7;
    }
    
    .image-upload-area input {
      display: none;
    }
    
    .image-upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .image-upload-text {
      font-size: 14px;
      color: #999;
    }
    
    /* å³ä¾§é¢„è§ˆåŒº */
    .preview-panel {
      position: sticky;
      top: 94px;
      height: fit-content;
      max-height: calc(100vh - 118px);
      display: flex;
      flex-direction: column;
    }
    
    .preview-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #fff;
      border-radius: 16px 16px 0 0;
    }
    
    .preview-content {
      max-width: 100%;
    }
    
    .preview-footer {
      padding: 16px 20px;
      background: #fff;
      border-top: 1px solid #f0f0f0;
      border-radius: 0 0 16px 16px;
      display: flex;
      gap: 12px;
    }
    
    .preview-footer .btn {
      flex: 1;
    }
    
    /* æ¨¡æ€æ¡† */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
    }
    
    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: #fff;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow: hidden;
      transform: scale(0.95);
      transition: transform 0.2s;
    }
    
    .modal-overlay.show .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid #f0f0f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .modal-close {
      width: 32px;
      height: 32px;
      border: none;
      background: #f5f5f5;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      color: #999;
    }
    
    .modal-close:hover {
      background: #eee;
      color: #666;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .modal-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid #e8e8e8;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 16px;
    }
    
    .modal-input:focus {
      outline: none;
      border-color: #9b8b7d;
    }
    
    .modal-divider {
      text-align: center;
      color: #999;
      font-size: 13px;
      margin: 20px 0;
      position: relative;
    }
    
    .modal-divider::before,
    .modal-divider::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: #eee;
    }
    
    .modal-divider::before { left: 0; }
    .modal-divider::after { right: 0; }
    
    .modal-upload-area {
      padding: 40px;
      border: 2px dashed #ddd;
      border-radius: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-upload-area:hover {
      border-color: #9b8b7d;
      background: #faf9f7;
    }
    
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #333;
      color: #fff;
      padding: 14px 28px;
      border-radius: 10px;
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
    
    /* æ‹–æ‹½æ ·å¼ */
    .block-item.dragging {
      opacity: 0.5;
    }
    
    .block-item.drag-over {
      border-top: 2px solid #9b8b7d;
    }
    
    /* æ·»åŠ æ¨¡å—æŒ‰é’® */
    .add-block-btn {
      width: 100%;
      padding: 16px;
      border: 2px dashed #e0e0e0;
      border-radius: 12px;
      background: transparent;
      color: #999;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .add-block-btn:hover {
      border-color: #9b8b7d;
      color: #9b8b7d;
      background: #faf9f7;
    }
  </style>
</head>
<body>

<header class="header">
  <div class="logo">
    <div class="logo-icon">ğŸ±</div>
    <span>çŒ«é—¨æ™ºèƒ½æ’ç‰ˆå™¨</span>
  </div>
  <div class="header-actions">
    <button class="btn btn-secondary" onclick="clearAll()">æ¸…ç©ºé‡æ¥</button>
    <button class="btn btn-primary" onclick="copyAllCode()">ğŸ“‹ å¤åˆ¶å…¨éƒ¨ä»£ç </button>
  </div>
</header>

<div class="container">
  <div class="editor-panel">
    <!-- è¾“å…¥é¢æ¿ -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-icon">ğŸ“</div>
          ç²˜è´´æ–‡ç« å†…å®¹
        </div>
      </div>
      <div class="input-section">
        <div class="textarea-wrapper">
          <textarea class="main-textarea" id="inputText" placeholder="åœ¨è¿™é‡Œç²˜è´´ä½ çš„æ–‡ç« å†…å®¹...

æ”¯æŒçš„æ ¼å¼ï¼š
â€¢ çº¯æ–‡æœ¬ - è‡ªåŠ¨æ™ºèƒ½è¯†åˆ«æ®µè½å’Œé‡‘å¥
â€¢ Markdown - è¯†åˆ« **åŠ ç²—**ã€> å¼•ç”¨ã€- åˆ—è¡¨ç­‰

ç¤ºä¾‹ï¼š
è¿™æ˜¯ä¸€æ®µæ™®é€šçš„æ­£æ–‡å†…å®¹ã€‚

**è¿™æ˜¯éœ€è¦å¼ºè°ƒçš„é‡ç‚¹**

> è¿™æ˜¯ä¸€å¥é‡‘å¥ï¼Œä¼šè¢«è‡ªåŠ¨è¯†åˆ«

- åˆ—è¡¨é¡¹ä¸€
- åˆ—è¡¨é¡¹äºŒ"></textarea>
        </div>
        <div class="input-hint">
          ğŸ’¡ æç¤ºï¼šæ”¯æŒ <code>**åŠ ç²—**</code> <code>> å¼•ç”¨</code> <code>- åˆ—è¡¨</code> <code>---åˆ†å‰²çº¿</code> ç­‰Markdownè¯­æ³•
        </div>
      </div>
      
      <div class="scheme-section">
        <span class="scheme-label">é€‰æ‹©é…è‰²ï¼š</span>
        <div class="scheme-options">
          <button class="scheme-btn active" data-scheme="morandi" title="è«å…°è¿ª" style="background: linear-gradient(135deg, #9b8b7d, #c4b5a5);"></button>
          <button class="scheme-btn" data-scheme="green" title="æ£®ç»¿" style="background: linear-gradient(135deg, #5d8a66, #7eb085);"></button>
          <button class="scheme-btn" data-scheme="purple" title="è–°è¡£è‰" style="background: linear-gradient(135deg, #8b7eb8, #a99cd1);"></button>
          <button class="scheme-btn" data-scheme="milktea" title="å¥¶èŒ¶" style="background: linear-gradient(135deg, #a67c52, #c9a77c);"></button>
          <button class="scheme-btn" data-scheme="blackgold" title="é»‘é‡‘" style="background: linear-gradient(135deg, #2d2d2d, #c9a962);"></button>
          <button class="scheme-btn" data-scheme="orange" title="æš–æ©™" style="background: linear-gradient(135deg, #d35400, #e67e22);"></button>
        </div>
      </div>
      
      <div class="action-section">
        <button class="btn-parse" onclick="parseContent()">âœ¨ æ™ºèƒ½è§£æå¹¶æ’ç‰ˆ</button>
        <button class="btn-add-image" onclick="openImageModal()">ğŸ–¼ï¸ æ·»åŠ å›¾ç‰‡</button>
      </div>
    </div>
    
    <!-- æ¨¡å—ç¼–è¾‘åŒº -->
    <div class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <div class="panel-title-icon">ğŸ“¦</div>
          å†…å®¹æ¨¡å—
          <span style="font-weight: 400; color: #999; font-size: 13px;" id="blockCount">(0ä¸ª)</span>
        </div>
      </div>
      <div class="blocks-container" id="blocksContainer">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“„</div>
          <div class="empty-state-text">
            ç²˜è´´æ–‡ç« å†…å®¹åç‚¹å‡»ã€Œæ™ºèƒ½è§£æã€<br>
            æˆ–æ‰‹åŠ¨æ·»åŠ å†…å®¹æ¨¡å—
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- é¢„è§ˆåŒº -->
  <div class="preview-panel panel">
    <div class="panel-header">
      <div class="panel-title">
        <div class="panel-title-icon">ğŸ‘ï¸</div>
        å®æ—¶é¢„è§ˆ
      </div>
    </div>
    <div class="preview-scroll">
      <div class="preview-content" id="previewContent">
        <div style="text-align: center; color: #ccc; padding: 60px 20px;">
          <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“±</div>
          <div>é¢„è§ˆæ•ˆæœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
        </div>
      </div>
    </div>
    <div class="preview-footer">
      <button class="btn btn-secondary" onclick="copyAllCode()">å¤åˆ¶ä»£ç </button>
      <button class="btn btn-primary" onclick="downloadHTML()">ä¸‹è½½HTML</button>
    </div>
  </div>
</div>

<!-- å›¾ç‰‡æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="imageModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æ·»åŠ å›¾ç‰‡</div>
      <button class="modal-close" onclick="closeImageModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="text" class="modal-input" id="imageUrlInput" placeholder="ç²˜è´´å›¾ç‰‡é“¾æ¥ (http://...)">
      <div class="modal-divider">æˆ–è€…</div>
      <div class="modal-upload-area" onclick="document.getElementById('imageFileInput').click()">
        <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“¤</div>
        <div style="color: #666;">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
        <div style="color: #999; font-size: 12px; margin-top: 4px;">æ”¯æŒ JPGã€PNGã€GIF</div>
        <input type="file" id="imageFileInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeImageModal()">å–æ¶ˆ</button>
      <button class="btn btn-primary" onclick="addImageFromUrl()">æ·»åŠ å›¾ç‰‡</button>
    </div>
  </div>
</div>

<!-- æ·»åŠ æ¨¡å—æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="addBlockModal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">æ·»åŠ å†…å®¹æ¨¡å—</div>
      <button class="modal-close" onclick="closeAddBlockModal()">Ã—</button>
    </div>
    <div class="modal-body">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('paragraph')">ğŸ“ æ™®é€šæ®µè½</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('emphasis')">ğŸ’ª å¼ºè°ƒæ–‡å­—</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('quote')">ğŸ’¬ é‡‘å¥æ¡†</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('heading')">ğŸ“Œ å°æ ‡é¢˜</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('list')">ğŸ“‹ åˆ—è¡¨é¡¹</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('divider')">â– åˆ†å‰²çº¿</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('card')">ğŸ´ è¦ç‚¹å¡ç‰‡</button>
        <button class="btn btn-secondary" style="padding: 16px;" onclick="addBlockManual('tip')">ğŸ å½©è›‹æ¡†</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

<script>
// é…è‰²æ–¹æ¡ˆ
const schemes = {
  morandi: {
    primary: '#9b8b7d',
    text: '#5a5a5a',
    textLight: '#777777',
    bgWarm: '#f7f5f3',
    bgWarmEnd: '#efe9e4',
    bgCard: '#f7f5f3',
    border: '#c4b5a5'
  },
  green: {
    primary: '#5d8a66',
    text: '#3d4a3f',
    textLight: '#666666',
    bgWarm: '#f4f9f5',
    bgWarmEnd: '#e8f2ea',
    bgCard: '#f4f9f5',
    border: '#7eb085'
  },
  purple: {
    primary: '#8b7eb8',
    text: '#4a4558',
    textLight: '#666666',
    bgWarm: '#f8f6fc',
    bgWarmEnd: '#f0ecf8',
    bgCard: '#f8f6fc',
    border: '#a99cd1'
  },
  milktea: {
    primary: '#a67c52',
    text: '#4d4035',
    textLight: '#6d5d4d',
    bgWarm: '#faf6f1',
    bgWarmEnd: '#f5ebe0',
    bgCard: '#faf6f1',
    border: '#c9a77c'
  },
  blackgold: {
    primary: '#c9a962',
    text: '#333333',
    textLight: '#555555',
    bgWarm: '#f9f8f5',
    bgWarmEnd: '#f3f0e8',
    bgCard: '#f9f8f5',
    border: '#c9a962',
    dark: '#2d2d2d'
  },
  orange: {
    primary: '#d35400',
    text: '#3f3f3f',
    textLight: '#666666',
    bgWarm: '#fff8f5',
    bgWarmEnd: '#fff0e8',
    bgCard: '#fffaf8',
    border: '#e67e22'
  }
};

let currentScheme = 'morandi';
let blocks = []; // å­˜å‚¨æ‰€æœ‰æ¨¡å—
let draggedItem = null;

// æ¨¡å—ç±»å‹åç§°
const blockTypeNames = {
  paragraph: 'æ™®é€šæ®µè½',
  emphasis: 'å¼ºè°ƒæ–‡å­—',
  quote: 'é‡‘å¥æ¡†',
  heading: 'å°æ ‡é¢˜',
  list: 'åˆ—è¡¨é¡¹',
  divider: 'åˆ†å‰²çº¿',
  card: 'è¦ç‚¹å¡ç‰‡',
  tip: 'å½©è›‹æ¡†',
  image: 'å›¾ç‰‡',
  footer: 'åº•éƒ¨è”ç³»'
};

// è§£ææ–‡ç« å†…å®¹
function parseContent() {
  const text = document.getElementById('inputText').value.trim();
  if (!text) {
    showToast('âš ï¸ è¯·å…ˆç²˜è´´æ–‡ç« å†…å®¹');
    return;
  }
  
  blocks = [];
  const lines = text.split('\n');
  let i = 0;
  
  while (i < lines.length) {
    const line = lines[i].trim();
    
    // è·³è¿‡ç©ºè¡Œ
    if (!line) {
      i++;
      continue;
    }
    
    // åˆ†å‰²çº¿
    if (/^[-*_]{3,}$/.test(line)) {
      blocks.push({ type: 'divider', content: '' });
      i++;
      continue;
    }
    
    // Markdownæ ‡é¢˜
    if (/^#{1,3}\s+/.test(line)) {
      const content = line.replace(/^#{1,3}\s+/, '');
      blocks.push({ type: 'heading', content });
      i++;
      continue;
    }
    
    // Markdownå¼•ç”¨ -> é‡‘å¥
    if (/^>\s*/.test(line)) {
      let quoteContent = line.replace(/^>\s*/, '');
      // æ£€æŸ¥æ˜¯å¦æœ‰è¿ç»­å¼•ç”¨
      while (i + 1 < lines.length && /^>\s*/.test(lines[i + 1].trim())) {
        i++;
        quoteContent += '\n' + lines[i].trim().replace(/^>\s*/, '');
      }
      blocks.push({ type: 'quote', content: quoteContent });
      i++;
      continue;
    }
    
    // Markdownåˆ—è¡¨
    if (/^[-*+]\s+/.test(line) || /^\d+\.\s+/.test(line)) {
      const listItems = [];
      while (i < lines.length) {
        const listLine = lines[i].trim();
        if (/^[-*+]\s+/.test(listLine)) {
          listItems.push(listLine.replace(/^[-*+]\s+/, ''));
        } else if (/^\d+\.\s+/.test(listLine)) {
          listItems.push(listLine.replace(/^\d+\.\s+/, ''));
        } else if (listLine === '') {
          break;
        } else {
          break;
        }
        i++;
      }
      blocks.push({ type: 'list', content: listItems.join('\n') });
      continue;
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯çº¯ç²—ä½“è¡Œ -> å¼ºè°ƒæˆ–å°æ ‡é¢˜
    if (/^\*\*[^*]+\*\*$/.test(line) || /^__[^_]+__$/.test(line)) {
      const content = line.replace(/^\*\*|\*\*$|^__|__$/g, '');
      // çŸ­çš„å½“å°æ ‡é¢˜ï¼Œé•¿çš„å½“å¼ºè°ƒ
      if (content.length <= 15) {
        blocks.push({ type: 'heading', content });
      } else {
        blocks.push({ type: 'emphasis', content });
      }
      i++;
      continue;
    }
    
    // æ£€æŸ¥æ˜¯å¦åƒé‡‘å¥ï¼ˆçŸ­å¥ã€æœ‰æ„Ÿæ‚Ÿæ€§è¯æ±‡ï¼‰
    if (isLikelyQuote(line)) {
      blocks.push({ type: 'quote', content: cleanMarkdown(line) });
      i++;
      continue;
    }
    
    // æ™®é€šæ®µè½ï¼ˆå¤„ç†å†…è”Markdownï¼‰
    let paragraphContent = line;
    // æ”¶é›†è¿ç»­çš„éç‰¹æ®Šè¡Œä½œä¸ºä¸€ä¸ªæ®µè½
    while (i + 1 < lines.length) {
      const nextLine = lines[i + 1].trim();
      if (!nextLine || isSpecialLine(nextLine)) break;
      paragraphContent += '\n' + nextLine;
      i++;
    }
    
    // æ£€æŸ¥æ®µè½ä¸­æ˜¯å¦æœ‰éœ€è¦å¼ºè°ƒçš„å†…å®¹
    if (/\*\*[^*]+\*\*/.test(paragraphContent) || /__[^_]+__/.test(paragraphContent)) {
      blocks.push({ type: 'paragraph', content: paragraphContent, hasEmphasis: true });
    } else {
      blocks.push({ type: 'paragraph', content: paragraphContent });
    }
    i++;
  }
  
  renderBlocks();
  updatePreview();
  showToast(`âœ… å·²è§£æå‡º ${blocks.length} ä¸ªå†…å®¹æ¨¡å—`);
}

// åˆ¤æ–­æ˜¯å¦æ˜¯ç‰¹æ®Šè¡Œ
function isSpecialLine(line) {
  return /^[-*_]{3,}$/.test(line) || // åˆ†å‰²çº¿
         /^#{1,3}\s+/.test(line) || // æ ‡é¢˜
         /^>\s*/.test(line) || // å¼•ç”¨
         /^[-*+]\s+/.test(line) || // æ— åºåˆ—è¡¨
         /^\d+\.\s+/.test(line) || // æœ‰åºåˆ—è¡¨
         /^\*\*[^*]+\*\*$/.test(line) || // çº¯ç²—ä½“
         /^__[^_]+__$/.test(line); // çº¯ç²—ä½“
}

// åˆ¤æ–­æ˜¯å¦åƒé‡‘å¥
function isLikelyQuote(line) {
  const cleanLine = cleanMarkdown(line);
  const length = cleanLine.length;
  
  // é•¿åº¦é€‚ä¸­çš„çŸ­å¥
  if (length < 10 || length > 80) return false;
  
  // åŒ…å«æ„Ÿæ‚Ÿæ€§è¯æ±‡
  const quoteKeywords = [
    'çœŸæ­£', 'å…¶å®', 'äººç”Ÿ', 'ç”Ÿæ´»', 'è®°ä½', 'æ°¸è¿œ', 'ä»æ¥', 'æœ€å¥½', 'æœ€é‡è¦',
    'ä¸æ˜¯', 'è€Œæ˜¯', 'å°±æ˜¯', 'æ‰æ˜¯', 'éƒ½æ˜¯', 'æ‰èƒ½', 'æ‰ä¼š', 'ä¸è¦', 'è¦å­¦ä¼š',
    'æ‡‚å¾—', 'æ˜ç™½', 'çŸ¥é“', 'ç›¸ä¿¡', 'å¸Œæœ›', 'å‹‡æ•¢', 'åšæŒ', 'é€‰æ‹©', 'æˆä¸º',
    'å€¼å¾—', 'é‡è¦', 'æ„ä¹‰', 'ä»·å€¼', 'å¹¸ç¦', 'å¿«ä¹', 'è‡ªç”±', 'æ¢¦æƒ³', 'æœªæ¥'
  ];
  
  const hasKeyword = quoteKeywords.some(kw => cleanLine.includes(kw));
  
  // ä»¥ç‰¹å®šæ ‡ç‚¹ç»“å°¾
  const endsWithPunctuation = /[ã€‚ï¼ï¼Ÿâ€¦]$/.test(cleanLine);
  
  // ç‹¬ç«‹æˆæ®µçš„çŸ­å¥ï¼ˆæ²¡æœ‰å¤ªå¤šæ ‡ç‚¹ï¼‰
  const punctuationCount = (cleanLine.match(/[ï¼Œã€‚ï¼ï¼Ÿã€ï¼›ï¼š]/g) || []).length;
  const isSimple = punctuationCount <= 3;
  
  return hasKeyword && endsWithPunctuation && isSimple && length >= 15 && length <= 60;
}

// æ¸…ç†Markdownæ ‡è®°
function cleanMarkdown(text) {
  return text
    .replace(/\*\*([^*]+)\*\*/g, '$1')
    .replace(/__([^_]+)__/g, '$1')
    .replace(/\*([^*]+)\*/g, '$1')
    .replace(/_([^_]+)_/g, '$1')
    .replace(/`([^`]+)`/g, '$1')
    .trim();
}

// æ¸²æŸ“æ¨¡å—åˆ—è¡¨
function renderBlocks() {
  const container = document.getElementById('blocksContainer');
  
  if (blocks.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“„</div>
        <div class="empty-state-text">
          ç²˜è´´æ–‡ç« å†…å®¹åç‚¹å‡»ã€Œæ™ºèƒ½è§£æã€<br>
          æˆ–æ‰‹åŠ¨æ·»åŠ å†…å®¹æ¨¡å—
        </div>
      </div>
    `;
    document.getElementById('blockCount').textContent = '(0ä¸ª)';
    return;
  }
  
  let html = '';
  blocks.forEach((block, index) => {
    html += renderBlockItem(block, index);
  });
  
  html += `<button class="add-block-btn" onclick="openAddBlockModal()">+ æ·»åŠ æ¨¡å—</button>`;
  
  container.innerHTML = html;
  document.getElementById('blockCount').textContent = `(${blocks.length}ä¸ª)`;
  
  // ç»‘å®šæ‹–æ‹½äº‹ä»¶
  bindDragEvents();
}

// æ¸²æŸ“å•ä¸ªæ¨¡å—
function renderBlockItem(block, index) {
  const typeOptions = Object.entries(blockTypeNames)
    .map(([value, label]) => `<option value="${value}" ${block.type === value ? 'selected' : ''}>${label}</option>`)
    .join('');
  
  let contentHtml = '';
  
  if (block.type === 'divider') {
    contentHtml = '<div style="text-align: center; color: #ccc;">â€”â€”â€”</div>';
  } else if (block.type === 'image') {
    contentHtml = `
      <div class="block-image-wrapper">
        ${block.content ? `<img src="${block.content}" class="block-image" alt="å›¾ç‰‡">` : ''}
        <input type="text" class="image-url-input" value="${block.content || ''}" 
               placeholder="å›¾ç‰‡é“¾æ¥" onchange="updateBlockContent(${index}, this.value)">
      </div>
    `;
  } else {
    contentHtml = `
      <textarea class="block-textarea" 
                placeholder="è¾“å…¥å†…å®¹..."
                onchange="updateBlockContent(${index}, this.value)"
                onfocus="this.parentElement.parentElement.classList.add('editing')"
                onblur="this.parentElement.parentElement.classList.remove('editing')"
      >${block.content || ''}</textarea>
    `;
  }
  
  return `
    <div class="block-item" draggable="true" data-index="${index}">
      <div class="block-header">
        <div class="block-type">
          <select class="block-type-select" onchange="changeBlockType(${index}, this.value)">
            ${typeOptions}
          </select>
        </div>
        <div class="block-actions">
          <button class="block-action-btn" onclick="moveBlockUp(${index})" title="ä¸Šç§»">â†‘</button>
          <button class="block-action-btn" onclick="moveBlockDown(${index})" title="ä¸‹ç§»">â†“</button>
          <button class="block-action-btn delete" onclick="deleteBlock(${index})" title="åˆ é™¤">Ã—</button>
        </div>
      </div>
      <div class="block-content">
        ${contentHtml}
      </div>
    </div>
  `;
}

// æ›´æ–°æ¨¡å—å†…å®¹
function updateBlockContent(index, content) {
  blocks[index].content = content;
  updatePreview();
}

// æ”¹å˜æ¨¡å—ç±»å‹
function changeBlockType(index, newType) {
  blocks[index].type = newType;
  renderBlocks();
  updatePreview();
}

// ç§»åŠ¨æ¨¡å—
function moveBlockUp(index) {
  if (index > 0) {
    [blocks[index], blocks[index - 1]] = [blocks[index - 1], blocks[index]];
    renderBlocks();
    updatePreview();
  }
}

function moveBlockDown(index) {
  if (index < blocks.length - 1) {
    [blocks[index], blocks[index + 1]] = [blocks[index + 1], blocks[index]];
    renderBlocks();
    updatePreview();
  }
}

// åˆ é™¤æ¨¡å—
function deleteBlock(index) {
  blocks.splice(index, 1);
  renderBlocks();
  updatePreview();
}

// ç»‘å®šæ‹–æ‹½äº‹ä»¶
function bindDragEvents() {
  const items = document.querySelectorAll('.block-item');
  
  items.forEach(item => {
    item.addEventListener('dragstart', handleDragStart);
    item.addEventListener('dragend', handleDragEnd);
    item.addEventListener('dragover', handleDragOver);
    item.addEventListener('drop', handleDrop);
    item.addEventListener('dragleave', handleDragLeave);
  });
}

function handleDragStart(e) {
  draggedItem = this;
  this.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  this.classList.remove('dragging');
  document.querySelectorAll('.block-item').forEach(item => {
    item.classList.remove('drag-over');
  });
}

function handleDragOver(e) {
  e.preventDefault();
  this.classList.add('drag-over');
}

function handleDragLeave(e) {
  this.classList.remove('drag-over');
}

function handleDrop(e) {
  e.preventDefault();
  this.classList.remove('drag-over');
  
  if (draggedItem !== this) {
    const fromIndex = parseInt(draggedItem.dataset.index);
    const toIndex = parseInt(this.dataset.index);
    
    const [movedItem] = blocks.splice(fromIndex, 1);
    blocks.splice(toIndex, 0, movedItem);
    
    renderBlocks();
    updatePreview();
  }
}

// ç”Ÿæˆç»„ä»¶HTML
function generateBlockHTML(block) {
  const s = schemes[currentScheme];
  
  switch (block.type) {
    case 'paragraph':
      let pContent = block.content || 'åœ¨æ­¤è¾“å…¥æ­£æ–‡å†…å®¹';
      // å¤„ç†å†…è”å¼ºè°ƒ
      pContent = pContent
        .replace(/\*\*([^*]+)\*\*/g, `<strong style="color: ${s.primary};">$1</strong>`)
        .replace(/__([^_]+)__/g, `<strong style="color: ${s.primary};">$1</strong>`)
        .replace(/\n/g, '<br>');
      return `<p style="font-size: 16px; color: ${s.text}; line-height: 2; letter-spacing: 0.5px; margin-bottom: 20px;">${pContent}</p>`;
    
    case 'emphasis':
      return `<p style="font-size: 16px; color: ${s.text}; line-height: 2; margin-bottom: 20px;"><strong style="color: ${s.primary};">${block.content || 'è¿™æ˜¯éœ€è¦å¼ºè°ƒçš„é‡ç‚¹å†…å®¹'}</strong></p>`;
    
    case 'heading':
      return `<p style="font-size: 18px; color: ${s.primary}; font-weight: bold; margin: 30px 0 15px 0;">${block.content || 'å°æ ‡é¢˜'}</p>`;
    
    case 'divider':
      return `<p style="text-align: center; color: #ccc; margin: 30px 0; font-size: 14px;">â€”â€”â€”</p>`;
    
    case 'quote':
      const quoteContent = (block.content || 'åœ¨æ­¤è¾“å…¥é‡‘å¥å†…å®¹').replace(/\n/g, '</p><p style="font-size: 17px; color: ' + s.primary + '; line-height: 2; margin: 10px 0 0 0; font-weight: bold;">');
      return `<section style="background: linear-gradient(135deg, ${s.bgWarm} 0%, ${s.bgWarmEnd} 100%); border-left: 4px solid ${s.primary}; padding: 20px 25px; margin: 25px 0; border-radius: 0 8px 8px 0;"><p style="font-size: 17px; color: ${s.primary}; line-height: 2; margin: 0; font-weight: bold;">${quoteContent}</p></section>`;
    
    case 'list':
      const items = (block.content || 'åˆ—è¡¨é¡¹ä¸€\nåˆ—è¡¨é¡¹äºŒ\nåˆ—è¡¨é¡¹ä¸‰').split('\n').filter(item => item.trim());
      const listHtml = items.map(item => 
        `<p style="font-size: 15px; color: ${s.textLight}; line-height: 2; margin-bottom: 8px; padding-left: 15px;">â†’ ${item.trim()}</p>`
      ).join('');
      return `<section style="background: ${s.bgCard}; padding: 25px; margin: 25px 0; border-radius: 12px;">${listHtml}</section>`;
    
    case 'card':
      const cardItems = (block.content || 'è¦ç‚¹ä¸€\nè¯´æ˜å†…å®¹\nè¦ç‚¹äºŒ\nè¯´æ˜å†…å®¹').split('\n').filter(item => item.trim());
      let cardHtml = '';
      for (let i = 0; i < cardItems.length; i += 2) {
        const title = cardItems[i] || '';
        const desc = cardItems[i + 1] || '';
        cardHtml += `<p style="font-size: 16px; color: ${s.text}; line-height: 2; margin-bottom: 15px;"><strong style="color: ${s.primary}; font-size: 18px;">${title}</strong>${desc ? '<br>' + desc : ''}</p>`;
      }
      return `<section style="background: ${s.bgCard}; padding: 25px; margin: 25px 0; border-radius: 12px;">${cardHtml}</section>`;
    
    case 'tip':
      return `<section style="border: 1px dashed ${s.border}; padding: 20px; margin: 25px 0; border-radius: 8px;"><p style="font-size: 14px; color: #999; line-height: 2; margin-bottom: 10px;">ã€å°åŠ©æ‰‹çš„æ‚„æ‚„è¯ã€‘</p><p style="font-size: 14px; color: ${s.textLight}; line-height: 2; margin-bottom: 10px;">${block.content || 'è¿™é‡Œæ˜¯æ­£æ–‡å†…å®¹'}</p></section>`;
    
    case 'image':
      if (block.content) {
        return `<p style="text-align: center; margin: 25px 0;"><img src="${block.content}" style="max-width: 100%; border-radius: 8px;" alt=""></p>`;
      }
      return '';
    
    case 'footer':
      return `<section style="background: ${s.bgCard}; padding: 20px; margin: 25px 0; border-radius: 12px; text-align: center;"><p style="font-size: 14px; color: ${s.textLight}; line-height: 2; margin-bottom: 10px;">â—¼ï¸ ${block.content || 'æ‰«ææµ·æŠ¥äºŒç»´ç æˆ–ç‚¹å‡»ã€Œé˜…è¯»åŸæ–‡ã€åŠ å…¥'}</p></section>`;
    
    default:
      return '';
  }
}

// æ›´æ–°é¢„è§ˆ
function updatePreview() {
  const container = document.getElementById('previewContent');
  
  if (blocks.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; color: #ccc; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">ğŸ“±</div>
        <div>é¢„è§ˆæ•ˆæœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>
      </div>
    `;
    return;
  }
  
  let html = '';
  blocks.forEach(block => {
    html += generateBlockHTML(block);
  });
  
  container.innerHTML = html;
}

// ç”Ÿæˆå®Œæ•´ä»£ç 
function generateFullCode() {
  let html = '';
  blocks.forEach(block => {
    html += generateBlockHTML(block);
  });
  return html;
}

// å¤åˆ¶å…¨éƒ¨ä»£ç 
function copyAllCode() {
  const code = generateFullCode();
  if (!code) {
    showToast('âš ï¸ æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
    return;
  }
  
  navigator.clipboard.writeText(code).then(() => {
    showToast('âœ… ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
  });
}

// ä¸‹è½½HTML
function downloadHTML() {
  const code = generateFullCode();
  if (!code) {
    showToast('âš ï¸ æ²¡æœ‰å¯ä¸‹è½½çš„å†…å®¹');
    return;
  }
  
  const blob = new Blob([code], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'å…¬ä¼—å·æ’ç‰ˆ.html';
  a.click();
  URL.revokeObjectURL(url);
  showToast('âœ… æ–‡ä»¶å·²ä¸‹è½½');
}

// æ¸…ç©ºå…¨éƒ¨
function clearAll() {
  if (blocks.length > 0 && !confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
    return;
  }
  blocks = [];
  document.getElementById('inputText').value = '';
  renderBlocks();
  updatePreview();
}

// å›¾ç‰‡ç›¸å…³
function openImageModal() {
  document.getElementById('imageModal').classList.add('show');
  document.getElementById('imageUrlInput').value = '';
}

function closeImageModal() {
  document.getElementById('imageModal').classList.remove('show');
}

function addImageFromUrl() {
  const url = document.getElementById('imageUrlInput').value.trim();
  if (url) {
    blocks.push({ type: 'image', content: url });
    renderBlocks();
    updatePreview();
    closeImageModal();
    showToast('âœ… å›¾ç‰‡å·²æ·»åŠ ');
  }
}

function handleImageUpload(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      blocks.push({ type: 'image', content: event.target.result });
      renderBlocks();
      updatePreview();
      closeImageModal();
      showToast('âœ… å›¾ç‰‡å·²æ·»åŠ ');
    };
    reader.readAsDataURL(file);
  }
}

// æ·»åŠ æ¨¡å—æ¨¡æ€æ¡†
function openAddBlockModal() {
  document.getElementById('addBlockModal').classList.add('show');
}

function closeAddBlockModal() {
  document.getElementById('addBlockModal').classList.remove('show');
}

function addBlockManual(type) {
  blocks.push({ type, content: '' });
  renderBlocks();
  updatePreview();
  closeAddBlockModal();
  
  // æ»šåŠ¨åˆ°æ–°æ·»åŠ çš„æ¨¡å—
  setTimeout(() => {
    const container = document.getElementById('blocksContainer');
    const items = container.querySelectorAll('.block-item');
    if (items.length > 0) {
      items[items.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }, 100);
}

// Toastæç¤º
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => {
    toast.classList.remove('show');
  }, 2000);
}

// é…è‰²åˆ‡æ¢
document.querySelectorAll('.scheme-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.scheme-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentScheme = btn.dataset.scheme;
    updatePreview();
  });
});

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) {
      overlay.classList.remove('show');
    }
  });
});
</script>

</body>
</html>
